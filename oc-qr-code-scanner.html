<link rel="import" href="../polymer/polymer-element.html">
<script src="../webrtc-adapter/release/adapter.js"></script>
<link rel="import" href="../app-media/app-media-devices.html">
<link rel="import" href="../app-media/app-media-stream.html">
<link rel="import" href="../app-media/app-media-video.html">
<link rel="import" href="../app-media/app-media-image-capture.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-icons/image-icons.html">

<link rel="import" href="jsqr-import.html">


<dom-module id="oc-qr-code-scanner">
    <template>
        <!-- BOOTSTRAP 4 CSS-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <style>
            :host {
                display: block;
            }
        </style>
        <app-media-devices
                id="mediaDevices"
                devices="{{devices}}"
                selected-device="{{device}}"
                kind="videoinput"></app-media-devices>

        <app-media-stream
                video-device="[[device]]"
                video-constraints="[[_getVideoConstraints]]"
                stream="{{videoStream}}"
                active></app-media-stream>

        <div class="container" hidden="[[!_showCamera]]">
            <div class="row">
                <div class="mx-auto" style="text-align: -webkit-center;">
                    <paper-button style="height: 20px; margin-bottom: 10px" raised on-tap="_nextDevice">Switch Camera</paper-button>
                </div>
            </div>
            <app-media-video
                    id="video"
                    source="[[videoStream]]"
                    autoplay
                    muted></app-media-video>

            <app-media-image-capture
                    id="imageCap"
                    stream="[[videoStream]]"
                    focus-mode="single-shot"
                    red-eye-reduction
                    last-frame="{{_frame}}">
            </app-media-image-capture>

            <div id="targetSquare"></div>
        </div>

        <div>

            <paper-ripple
                    id="ripple"
                    noink></paper-ripple>


            <div class="row" hidden="[[_showCamera]]">
                <div class="mx-auto" style="text-align: -webkit-center;">
                    <div style="font-size: 14px; padding-bottom: 30px;">Scan QR Code</div>
                    <paper-fab icon="image:camera-alt" on-tap="_takeFrame" style="margin-top: -30px;"></paper-fab>
                </div>
            </div>
        </div>

    </template>
    <script>

		class OcQrCodeScanner extends Polymer.Element {

			static get is() {
				return 'oc-qr-code-scanner';
			}

			static get properties() {
				return {

					visible: {
						type: Boolean,
					},

					_frame: {
						type: Object,
						observer: '_onFrameTaken'
					},
					/* If qr code is not decode it will return a null*/
					data: {
						type: String,
						notify: true,
						observer: '_onQrDecoded'
					},
					/* Last decoded frame */
					_lastDataItem: {
						type: String
					},
					/* Just an indication that qr code was found. This will be set to false on each instance*/
					_qrFound: {
						type: Boolean,
						value: false,
					},
					_showCamera: {
						type: Boolean,
						value: false,
					},
				}
			}

			ready() {
				super.ready();
			}

			_onQrDecoded(newVal, oldVal) {
				if (newVal) {
					this._qrFound = true;
					this._showCamera = false;
				}
			}

			_takeFrame(e) {
				this._showCamera = true;

				const self = this;
				let time = 1;
				const interval = setInterval(() => {
					// This 100 value is relative. THis might change at a later change
					if (time <= 100 && !this._qrFound && this._showCamera) {
						self.$.imageCap.grabFrame();
						time++;
					}
					else {
						clearInterval(interval);
						this._showCamera = false;
						this._qrFound = false;
						time = 1;
					}
				}, 1000);
			}

			convertURIToImageData(URI) {
				return new Promise((resolve, reject) => {
					if (URI == null) return reject();
					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');

					context.drawImage(URI, 0, 0, canvas.width, canvas.height);
					resolve(context.getImageData(0, 0, canvas.width, canvas.height));
				});
			}

			_onFrameTaken(t) {
				this.convertURIToImageData(t).then((imageData) => {
					// Here you can use imageData
					const qrObject = jsQR(imageData.data, imageData.width, imageData.height);
					if (qrObject) {
						this.data = qrObject.data;

						// If new image matches the old image exit and close camara. No need for further scanning
						if (this.data === this._lastDataItem)
							this._showCamera = false;

						this._lastDataItem = qrObject.data;
					}
				});
			}

			_nextDevice() {
				this.$.mediaDevices.selectNextDevice()
			}

			_getVideoConstraints() {
				return {
					width: {min: 1024, ideal: 1280, max: 1920},
					height: {min: 776, ideal: 720, max: 1080},
                    facingMode: "environment"
				}
			}


			_visibleChanged(visible) {
				if (visible) {
					this.dispatchEvent(new CustomEvent('change-section', {
						bubbles: true, composed: true, detail: {title: 'QR Code'}
					}));
				}
			}
		}

		customElements.define(OcQrCodeScanner.is, OcQrCodeScanner);

    </script>
</dom-module>
