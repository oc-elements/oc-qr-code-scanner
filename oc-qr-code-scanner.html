<link rel="import" href="../polymer/polymer-element.html">
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<link rel="import" href="../app-media/app-media-devices.html">
<link rel="import" href="../app-media/app-media-stream.html">
<link rel="import" href="../app-media/app-media-video.html">
<link rel="import" href="../app-media/app-media-image-capture.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../../src/oc-button-styles.html">

<link rel="import" href="jsqr-import.html">


<dom-module id="oc-qr-code-scanner">
    <template>
        <!-- BOOTSTRAP 4 CSS-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <style include="oc-button-styles" is="custom-style">
            :host {
                display: block;
            }
            .camera-icon {
                margin-left:8px;
            }

            .targetSquare {
                position: absolute;
                border: solid 5px rgba(200,200,200,0.5);
            }

            .container {
                position: absolute;
                z-index: 1000;
                left: 0;
                padding: 0 !important;
            }

        </style>
        <app-media-devices
                id="mediaDevices"
                devices="{{devices}}"
                selected-device="{{device}}"
                kind="videoinput"></app-media-devices>

        <app-media-stream
                video-device="[[device]]"
                video-constraints="[[_getVideoConstraints]]"
                stream="{{videoStream}}"
                active></app-media-stream>

        <div id="container" class="container" hidden="[[!_showCamera]]">
            <div class="row">
                <div class="mx-auto" style="text-align: -webkit-center;">
                    <paper-button style="height: 20px; margin-bottom: 10px" raised on-tap="_exitCamera">Exit Camera</paper-button>
                    <paper-button class="secondary-button"  raised on-tap="_nextDevice">Switch Camera <iron-icon class="camera-icon" icon="image:switch-camera"></iron-icon>
                    </paper-button>
                    

                </div>
            </div>
            <app-media-video
                    id="video"
                    source="[[videoStream]]"
                    autoplay
                    muted>
            </app-media-video>

            <app-media-image-capture
                    id="imageCapture"
                    stream="[[videoStream]]"
                    focus-mode="single-shot"
                    red-eye-reduction
                    last-frame="{{_frame}}">
            </app-media-image-capture>
            <div id="targetSquare" class="targetSquare"></div>
        </div>

        <div>

            <paper-ripple
                    id="ripple"
                    noink></paper-ripple>

            <div class="row" hidden="[[_showCamera]]">
                <div class="mx-auto" style="text-align: -webkit-center;">
                    <paper-button class="secondary-button" raised on-tap="_takeFrame">Scan QR Code <iron-icon class="camera-icon" icon="image:photo-camera"></iron-icon></paper-button>
                </div>
            </div>
        </div>

    </template>
    <script>

		class OcQrCodeScanner extends Polymer.Element {

			static get is() {
				return 'oc-qr-code-scanner';
			}

			static get properties() {
				return {

					visible: {
						type: Boolean,
					},

					_frame: {
						type: Object,
						observer: '_onFrameTaken'
					},
					/* If qr code is not decode it will return a null*/
					data: {
						type: String,
						notify: true,
						observer: '_onQrDecoded'
					},
					/* Last decoded frame */
					_lastDataItem: {
						type: String
					},
					/* Just an indication that qr code was found. This will be set to false on each instance*/
					_qrFound: {
						type: Boolean,
						value: false,
					},
					_showCamera: {
						type: Boolean,
						value: false,
					},
				}
			}

			ready() {
				super.ready();
			}

			_onQrDecoded(newVal, oldVal) {
				if (newVal) {
					this._qrFound = true;
					this._showCamera = false;
				}
			}

			_frameGrabRepeat() {
				// This 100 value is relative. THis might change at a later change
				if (this.time <= 100 && !this._qrFound && this._showCamera) {
					this.$.imageCapture.grabFrame()
						.then()
						.catch(err => console.error('grabFrame() failed: ', err));
					this.time++;
				}
				else {
					clearInterval(this.interval);
					this._showCamera = false;
					this._qrFound = false;
					this.time = 1;
				}
			}

			_calculateStyling() {
				/* Style the camera so it is full screen on mobile*/
				this.$.container.setAttribute("style", "top:" + this.offsetTop + "px;" +
					"height:" + (window.innerHeight - this.offsetTop - 50) + "px;" +
					"width:" + window.outerWidth + "px");

				/* Style the target square to be within the video*/
				this.$.targetSquare.setAttribute("style", "left:" + (this.$.video.offsetLeft + 60) + "px;" +
					"top:" + (this.$.video.offsetTop + 80) + "px;" +
					"width:" + (this.$.video.offsetWidth - 120) + "px;" +
					"height:" + (this.$.video.offsetHeight - 160) + "px");
			}

			_takeFrame() {
				this._showCamera = true;

				this._calculateStyling();

				this.time = 1;
				this.interval = setInterval(this._frameGrabRepeat.bind(this), 1000);
			}

			convertURIToImageData(URI) {
				return new Promise((resolve, reject) => {
					if (URI == null) return reject();
					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');

					context.drawImage(URI, 0, 0, canvas.width, canvas.height);
					resolve(context.getImageData(0, 0, canvas.width, canvas.height));
				});
			}

			_onFrameTaken(t) {
				this.convertURIToImageData(t).then((imageData) => {
					// Here you can use imageData
					const qrObject = jsQR(imageData.data, imageData.width, imageData.height);
					if (qrObject) {
						this.data = qrObject.data;

						// If new image matches the old image exit and close camara. No need for further scanning
						if (this.data === this._lastDataItem)
							this._showCamera = false;

						this._lastDataItem = qrObject.data;
					}
				});
			}

			_exitCamera() {
				this._showCamera = false;
            }

			_nextDevice() {
				this.$.mediaDevices.selectNextDevice()
			}

			_getVideoConstraints() {
				return {
					width: {min: 1024, ideal: 1280, max: 1920},
					height: {min: 776, ideal: 720, max: 1080},
					facingMode: "environment"
				}
			}


			_visibleChanged(visible) {
				if (visible) {
					this.dispatchEvent(new CustomEvent('change-section', {
						bubbles: true, composed: true, detail: {title: 'QR Code'}
					}));
				}
			}
		}

		customElements.define(OcQrCodeScanner.is, OcQrCodeScanner);

    </script>
</dom-module>
